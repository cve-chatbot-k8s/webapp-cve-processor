#!/bin/sh

set -x

KAFKA_CLUSTER="${KAFKA_BOOTSTRAP_SERVERS}"
TOPIC="${KAFKA_TOPIC}"
DB_HEALTH_URL="${DB_HEALTH_URL}"

check_kafka() {
  if kcat -L -b "$KAFKA_CLUSTER" | grep -q "$TOPIC" && echo "$KAFKA_CLUSTER" | tr "," "\n" | while read -r broker; do nc -zv "$(echo $broker | awk -F: '{print $1}')" "$(echo $broker | awk -F: '{print $2}')" && exit 0 || exit 1; done
  then
    return 0
  else
    return 1
  fi
}

# Check if the database is healthy
check_db() {
  if curl -f "$DB_HEALTH_URL"; then
    return 0
  else
    return 1
  fi
}

# Perform both checks
if check_kafka && check_db; then
  exit 0
else
  exit 1
fi
