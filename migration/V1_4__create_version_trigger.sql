-- Create a function that will be used by the trigger to increment the version
CREATE OR REPLACE FUNCTION versioning_trigger() RETURNS TRIGGER AS $$
DECLARE
max_version INT;
BEGIN
SELECT MAX(version) INTO max_version FROM cve.CVE_RECORDS WHERE cve_id = NEW.cve_id;
IF max_version IS NULL THEN
        NEW.version := 1;
ELSE
        NEW.version := max_version + 1;
END IF;
RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create a trigger that calls the versioning function before each insert
CREATE TRIGGER versioning_before_insert
    BEFORE INSERT ON cve.CVE_RECORDS
    FOR EACH ROW
    EXECUTE PROCEDURE versioning_trigger();